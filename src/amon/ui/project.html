<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amon｜專案工作台</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="page">
      <div class="layout">
        <header class="topbar">
          <div class="topbar-title" id="project-title">專案：—</div>
          <button class="dropdown-btn" disabled>切換模式 ▾</button>
        </header>
        <div class="notice subtle">
          此頁面目前僅顯示專案資訊，任務、對話、文件功能尚未開放（避免無效控制項）。
        </div>

        <section class="workspace-grid">
          <div class="panel">
            <h3>任務清單</h3>
            <div class="task-item disabled">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span class="status-dot" style="background: var(--accent);"></span>
                <span class="task-title">競品摘要</span>
              </div>
              <div class="task-meta">狀態：執行中</div>
            </div>
            <div class="task-item secondary disabled">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span class="status-dot" style="background: var(--warning);"></span>
                <span class="task-title">風險與限制</span>
              </div>
              <div class="task-meta">狀態：審查中</div>
            </div>
          </div>

          <div class="panel">
            <h3>對話</h3>
            <div class="chat-bubble user">你：請做 2026Q1 市場研究，整理競品與策略。</div>
            <div class="chat-bubble agent">
              Amon：我會用「團隊模式」拆任務並產出文件。<br />
              接著我會先給你一份待辦清單供確認。
            </div>
            <div class="chat-input disabled">
              <div class="field">輸入任務…</div>
              <button class="send" disabled>送出</button>
            </div>
          </div>

          <div class="panel">
            <h3>文件</h3>
            <div class="doc-item disabled">
              <div class="task-title">PM_整合報告.md</div>
              <div class="doc-meta" style="color: var(--success);">Final</div>
            </div>
            <div class="doc-item secondary disabled">
              <div class="task-title">競品摘要_成員A.md</div>
            </div>
            <div class="doc-item secondary disabled">
              <div class="task-title">稽核回饋.json</div>
            </div>
          </div>
        </section>

        <section class="graph-section">
          <div class="panel graph-panel">
            <div class="panel-header">
              <div>
                <h3 style="margin-bottom: 6px;">Graph 檢視器</h3>
                <p class="panel-hint">支援檢視、視覺化與變數替代範本，方便快速確認 DAG 執行路徑。</p>
              </div>
              <span class="badge badge-soft">DAG</span>
            </div>
            <div class="graph-grid">
              <div class="graph-config">
                <div class="field-label">graph.json</div>
                <div class="code-box">
                  { "nodes": [{ "id": "agent", "type": "agent_task", "prompt": "整理 ${topic}" }], "edges": [] }
                </div>

                <div class="field-label">變數</div>
                <div class="chip-row">
                  <span class="chip">topic=2026Q1 市場研究</span>
                  <span class="chip muted">owner=PM</span>
                </div>

                <div class="field-label">變數替代為範本</div>
                <div class="code-box muted">
                  { "nodes": [{ "id": "agent", "type": "agent_task", "prompt": "整理 ${topic}" }], "variables": { "topic": "2026Q1 市場研究" } }
                </div>

                <div class="graph-actions">
                  <button class="secondary-btn" disabled>轉為變數範本</button>
                  <button class="primary-btn small" disabled>視覺化</button>
                </div>
                <div class="progress graph-progress"><span></span></div>
              </div>

              <div class="graph-visual">
                <div class="graph-canvas">
                  <svg viewBox="0 0 340 200" role="img" aria-label="Graph 視覺化">
                    <rect x="20" y="20" width="120" height="48" rx="12" fill="#eef2ff"></rect>
                    <text x="80" y="48" text-anchor="middle" font-size="12" fill="#1e40af">write_file</text>
                    <rect x="200" y="20" width="120" height="48" rx="12" fill="#fdf2f8"></rect>
                    <text x="260" y="48" text-anchor="middle" font-size="12" fill="#db2777">condition</text>
                    <rect x="110" y="120" width="120" height="48" rx="12" fill="#e0f2fe"></rect>
                    <text x="170" y="148" text-anchor="middle" font-size="12" fill="#0f172a">agent_task</text>
                    <path d="M140 44 L200 44" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)"></path>
                    <path d="M260 68 L190 120" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)"></path>
                    <defs>
                      <marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
                        <path d="M0,0 L0,6 L6,3 z" fill="#94a3b8"></path>
                      </marker>
                    </defs>
                  </svg>
                </div>
                <div class="graph-legend">
                  <div><span class="legend-dot" style="background: #eef2ff;"></span>write_file</div>
                  <div><span class="legend-dot" style="background: #fdf2f8;"></span>condition</div>
                  <div><span class="legend-dot" style="background: #e0f2fe;"></span>agent_task</div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <div id="toast" class="toast toast--info" role="status" aria-live="polite"></div>
    <div id="confirm-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
      <div class="confirm-modal__panel">
        <h3 class="confirm-modal__title" data-confirm-title>請再次確認</h3>
        <p class="confirm-modal__description" data-confirm-description>這個動作無法復原，是否繼續？</p>
        <div class="confirm-modal__actions">
          <button type="button" class="secondary-btn" data-confirm-cancel>取消</button>
          <button type="button" class="primary-btn" data-confirm-ok>確認</button>
        </div>
      </div>
    </div>
    <script src="/ui_components.js"></script>
    <script>
      const { createToastManager, createConfirmModal } = window.AmonUIComponents;
      const toast = document.getElementById("toast");
      const confirmModalElement = document.getElementById("confirm-modal");
      const titleEl = document.getElementById("project-title");
      const toastManager = createToastManager(toast);
      const confirmModal = createConfirmModal(confirmModalElement);

      function showToast(message) {
        toastManager.show(message, { duration: 8000 });
      }

      window.amonProjectDebug = {
        showToast,
        showConfirmModal: (options) => confirmModal.open(options),
      };

      async function loadProject() {
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get("id");
        if (!projectId) {
          titleEl.textContent = "專案：未指定";
          return;
        }
        try {
          const response = await fetch(`/v1/projects/${projectId}`);
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.message || "讀取專案失敗");
          }
          titleEl.textContent = `專案：${payload.project.name}`;
        } catch (error) {
          titleEl.textContent = "專案：讀取失敗";
          showToast(`無法連線本機 API：${error.message}`);
        }
      }

      loadProject();
    </script>
  </body>
</html>
