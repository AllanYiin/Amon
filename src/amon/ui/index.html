<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amon｜Chat UI</title>
    <link rel="stylesheet" href="styles.css" />
    <script type="module">
      import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
      mermaid.initialize({ startOnLoad: false, theme: "neutral" });
      window.__mermaid = mermaid;
    </script>
  </head>
  <body>
    <main class="page">
      <div class="layout chat-layout">
        <section class="main-card chat-panel">
          <header class="chat-header">
            <div>
              <h1>Amon Chat</h1>
              <p class="subtitle">請用自然語言操作專案與任務（支援 streaming）。</p>
            </div>
            <div class="chat-controls">
              <label class="field-label">
                專案
                <select id="project-select"></select>
              </label>
              <button class="secondary-btn" id="refresh-context">刷新 Context</button>
            </div>
          </header>

          <section id="timeline" class="chat-timeline"></section>

          <div class="progress-bar" id="stream-progress" aria-hidden="true">
            <span></span>
          </div>

          <section id="plan-card" class="plan-card" hidden>
            <div class="plan-card__header">
              <h3>Plan Card</h3>
              <p>此操作需要確認才能繼續。</p>
            </div>
            <pre id="plan-content"></pre>
            <div class="plan-card__actions">
              <button class="secondary-btn" id="plan-cancel">取消</button>
              <button class="primary-btn" id="plan-confirm">確認執行</button>
            </div>
          </section>

          <form id="chat-form" class="chat-input">
            <textarea id="chat-input" rows="2" placeholder="輸入你的需求，例如：建立專案 Amon Demo"></textarea>
            <button type="submit" class="primary-btn">送出</button>
          </form>
        </section>

        <aside class="context-panel">
          <h2>Context</h2>
          <section class="context-section">
            <h3>Graph Preview</h3>
            <div id="graph-preview" class="graph-preview"></div>
            <pre id="graph-code" class="graph-code"></pre>
          </section>
          <section class="context-section">
            <h3>Docs</h3>
            <ul id="docs-list" class="docs-list"></ul>
          </section>
        </aside>
      </div>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
      const state = {
        chatId: null,
        projectId: null,
        plan: null,
        streaming: false,
      };

      const elements = {
        projectSelect: document.getElementById("project-select"),
        timeline: document.getElementById("timeline"),
        chatForm: document.getElementById("chat-form"),
        chatInput: document.getElementById("chat-input"),
        toast: document.getElementById("toast"),
        planCard: document.getElementById("plan-card"),
        planContent: document.getElementById("plan-content"),
        planConfirm: document.getElementById("plan-confirm"),
        planCancel: document.getElementById("plan-cancel"),
        refreshContext: document.getElementById("refresh-context"),
        graphPreview: document.getElementById("graph-preview"),
        graphCode: document.getElementById("graph-code"),
        docsList: document.getElementById("docs-list"),
        streamProgress: document.getElementById("stream-progress"),
      };

      function showToast(message) {
        elements.toast.textContent = message;
        elements.toast.classList.add("visible");
        window.clearTimeout(elements.toast._timer);
        elements.toast._timer = window.setTimeout(() => {
          elements.toast.classList.remove("visible");
        }, 9000);
      }

      async function apiFetch(path, options = {}) {
        const response = await fetch(`/v1${path}`, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        let payload = {};
        try {
          payload = await response.json();
        } catch (error) {
          payload = {};
        }
        if (!response.ok) {
          throw new Error(payload.message || "API 發生錯誤");
        }
        return payload;
      }

      function appendMessage(role, text) {
        const bubble = document.createElement("div");
        bubble.className = `chat-bubble ${role}`;
        bubble.textContent = text;
        elements.timeline.appendChild(bubble);
        elements.timeline.scrollTop = elements.timeline.scrollHeight;
        return bubble;
      }

      function setStreaming(active) {
        state.streaming = active;
        elements.streamProgress.hidden = !active;
        elements.chatInput.disabled = active;
      }

      function resetPlanCard() {
        state.plan = null;
        elements.planCard.hidden = true;
        elements.planContent.textContent = "";
      }

      async function loadProjects() {
        const payload = await apiFetch("/projects");
        const projects = payload.projects || [];
        elements.projectSelect.innerHTML = "";
        projects.forEach((project) => {
          const option = document.createElement("option");
          option.value = project.project_id;
          option.textContent = `${project.name}（${project.project_id}）`;
          elements.projectSelect.appendChild(option);
        });
        if (!state.projectId && projects.length) {
          state.projectId = projects[0].project_id;
          elements.projectSelect.value = state.projectId;
        }
        if (!projects.length) {
          showToast("尚無專案，請在聊天輸入：建立專案 <名稱>");
        }
      }

      async function ensureChatSession() {
        if (!state.projectId) return;
        const payload = await apiFetch("/chat/sessions", {
          method: "POST",
          body: JSON.stringify({ project_id: state.projectId }),
        });
        state.chatId = payload.chat_id;
      }

      async function loadContext() {
        if (!state.projectId) return;
        const payload = await apiFetch(`/projects/${state.projectId}/context`);
        elements.graphCode.textContent = payload.graph_mermaid || "";
        renderMermaid(payload.graph_mermaid || "");
        renderDocs(payload.docs || []);
      }

      function renderDocs(docs) {
        elements.docsList.innerHTML = "";
        if (!docs.length) {
          const item = document.createElement("li");
          item.textContent = "尚無文件";
          elements.docsList.appendChild(item);
          return;
        }
        docs.forEach((doc) => {
          const item = document.createElement("li");
          item.textContent = doc;
          elements.docsList.appendChild(item);
        });
      }

      async function renderMermaid(code) {
        elements.graphPreview.innerHTML = "";
        if (!code) return;
        try {
          const { svg } = await window.__mermaid.render("graphPreview", code);
          elements.graphPreview.innerHTML = svg;
        } catch (error) {
          elements.graphPreview.innerHTML = "<p>Mermaid 渲染失敗，請檢查 graph。</p>";
        }
      }

      function showPlanCard(plan) {
        state.plan = plan;
        elements.planContent.textContent = plan.plan_card || "";
        elements.planCard.hidden = false;
      }

      async function confirmPlan(confirmed) {
        if (!state.plan) return;
        try {
          await apiFetch("/chat/plan/confirm", {
            method: "POST",
            body: JSON.stringify({
              project_id: state.projectId,
              chat_id: state.chatId,
              command: state.plan.command,
              args: state.plan.args || {},
              confirmed,
            }),
          });
          appendMessage("agent", confirmed ? "已確認執行。" : "已取消執行。");
          resetPlanCard();
        } catch (error) {
          showToast(`Plan 執行失敗：${error.message}`);
        }
      }

      function startStream(message) {
        if (!state.projectId) {
          showToast("請先選擇專案。若尚未建立專案，請先建立。 ");
          return;
        }
        if (!state.chatId) {
          showToast("尚未建立 chat session。");
          return;
        }
        resetPlanCard();
        appendMessage("user", `你：${message}`);
        const agentBubble = appendMessage("agent", "Amon：");
        setStreaming(true);

        const query = new URLSearchParams({
          project_id: state.projectId,
          chat_id: state.chatId,
          message,
        });
        const source = new EventSource(`/v1/chat/stream?${query.toString()}`);
        let buffer = "";

        source.addEventListener("token", (event) => {
          const data = JSON.parse(event.data || "{}");
          buffer += data.text || "";
          agentBubble.textContent = `Amon：${buffer}`;
          elements.timeline.scrollTop = elements.timeline.scrollHeight;
        });

        source.addEventListener("notice", (event) => {
          const data = JSON.parse(event.data || "{}");
          if (data.text) {
            appendMessage("agent", data.text);
          }
        });

        source.addEventListener("plan", (event) => {
          const data = JSON.parse(event.data || "{}");
          showPlanCard(data);
          agentBubble.textContent = "Amon：已產生 Plan Card，請確認。";
        });

        source.addEventListener("result", (event) => {
          const data = JSON.parse(event.data || "{}");
          agentBubble.textContent = `Amon：${JSON.stringify(data, null, 2)}`;
        });

        source.addEventListener("error", (event) => {
          try {
            const data = JSON.parse(event.data || "{}");
            showToast(data.message || "串流失敗");
          } catch (error) {
            showToast("串流失敗");
          }
        });

        source.addEventListener("done", async () => {
          source.close();
          setStreaming(false);
          await loadContext();
        });
      }

      elements.chatForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const message = elements.chatInput.value.trim();
        if (!message) return;
        elements.chatInput.value = "";
        startStream(message);
      });

      elements.projectSelect.addEventListener("change", async (event) => {
        state.projectId = event.target.value;
        await ensureChatSession();
        await loadContext();
      });

      elements.refreshContext.addEventListener("click", loadContext);
      elements.planConfirm.addEventListener("click", () => confirmPlan(true));
      elements.planCancel.addEventListener("click", () => confirmPlan(false));

      (async () => {
        try {
          await loadProjects();
          await ensureChatSession();
          await loadContext();
        } catch (error) {
          showToast(`初始化失敗：${error.message}`);
        }
      })();
    </script>
  </body>
</html>
