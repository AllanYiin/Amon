<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amon｜Chat UI</title>
    <link rel="stylesheet" href="styles.css" />
    <script type="module">
      import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
      mermaid.initialize({ startOnLoad: false, theme: "neutral" });
      window.__mermaid = mermaid;
    </script>
  </head>
  <body>
    <main class="page">
      <div class="ui-shell" id="ui-shell">
        <aside class="shell-sidebar" aria-label="主要導覽">
          <h2>Amon UI</h2>
          <nav class="shell-nav" id="shell-nav">
            <button type="button" class="shell-nav__item is-active" data-shell-view="chat">Chat</button>
            <button type="button" class="shell-nav__item" data-shell-view="context">Context</button>
            <button type="button" class="shell-nav__item" data-shell-view="graph">Graph</button>
            <button type="button" class="shell-nav__item" data-shell-view="tools-skills">Tools &amp; Skills</button>
            <button type="button" class="shell-nav__item" data-shell-view="config">Config</button>
            <button type="button" class="shell-nav__item" data-shell-view="logs-events">Logs &amp; Events</button>
            <button type="button" class="shell-nav__item" data-shell-view="docs">Docs</button>
            <button type="button" class="shell-nav__item" data-shell-view="bill">Bill</button>
          </nav>
        </aside>

        <section class="shell-main">
          <header class="shell-topbar" aria-label="工作列">
            <div class="shell-topbar__group">
              <label class="field-label shell-topbar__field">
                Project
                <select id="project-select"></select>
              </label>
              <span class="shell-status shell-status--run" id="shell-run-status">Run：Idle</span>
              <span class="shell-status shell-status--daemon" id="shell-daemon-status">Daemon：Healthy</span>
              <span class="shell-status shell-status--budget" id="shell-budget-status">Budget：NT$ 0 / NT$ 5,000</span>
            </div>
            <button type="button" class="secondary-btn shell-context-toggle" id="toggle-context-panel" aria-expanded="true">收合右側面板</button>
          </header>

          <div class="layout chat-layout" id="chat-layout">
            <section class="main-card chat-panel">
          <header class="chat-header">
            <div>
              <h1>Amon Chat</h1>
              <p class="subtitle">請用自然語言操作專案與任務（支援 streaming）。</p>
            </div>
            <div class="chat-controls">
              <span class="chat-project-label" id="chat-project-label">目前專案：未指定專案</span>
              <button class="secondary-btn" id="refresh-context">刷新 Context</button>
            </div>
          </header>

          <section id="timeline" class="chat-timeline"></section>

          <section class="thinking-panel" id="thinking-panel">
            <div class="thinking-panel__header">
              <h3>Thinking 狀態</h3>
              <label class="field-label thinking-mode">
                顯示模式
                <select id="thinking-mode">
                  <option value="off">off</option>
                  <option value="brief" selected>brief</option>
                  <option value="verbose">verbose</option>
                </select>
              </label>
            </div>
            <details open id="thinking-details">
              <summary id="thinking-summary">目前沒有 Thinking 事件</summary>
              <div id="thinking-detail" class="thinking-panel__detail"></div>
            </details>
          </section>

          <div class="progress-bar" id="stream-progress" aria-hidden="true">
            <span></span>
          </div>

          <section id="plan-card" class="plan-card" hidden>
            <div class="plan-card__header">
              <h3>Plan Card</h3>
              <p>此操作需要確認才能繼續。</p>
            </div>
            <div class="plan-grid">
              <div>
                <h4>Commands</h4>
                <ul id="plan-commands" class="plan-list"></ul>
              </div>
              <div>
                <h4>Graph Patches</h4>
                <ul id="plan-patches" class="plan-list"></ul>
              </div>
            </div>
            <div class="plan-risk" id="plan-risk"></div>
            <pre id="plan-content"></pre>
            <div class="plan-card__actions">
              <button class="secondary-btn" id="plan-cancel">取消</button>
              <button class="primary-btn" id="plan-confirm">確認執行</button>
            </div>
          </section>

          <section class="artifact-section">
            <div class="artifact-section__header">
              <h3>Artifacts</h3>
              <p>顯示來自 run/node 的產出。</p>
            </div>
            <div id="artifact-list" class="artifact-list"></div>
          </section>

          <form id="chat-form" class="chat-input">
            <div class="chat-input__main">
              <textarea id="chat-input" rows="4" placeholder="輸入你的需求，例如：建立專案 Amon Demo"></textarea>
              <div class="chat-input__toolbar">
                <label class="file-btn">
                  加入附件
                  <input id="chat-attachments" type="file" multiple accept="image/*,video/*,.pdf" />
                </label>
                <span class="chat-input__hint">支援圖片、PDF、影片；附件會以文字摘要送出。</span>
              </div>
              <div id="attachment-preview" class="attachment-preview"></div>
            </div>
            <button type="submit" class="primary-btn">送出</button>
          </form>
        </section>

            <aside class="context-panel" id="context-panel">
          <h2>右側資訊</h2>
          <div class="context-shell-placeholders" aria-label="右側狀態摘要">
            <div class="context-shell-card">
              <p class="context-shell-card__label">Memory Used</p>
              <strong id="card-memory-used">--</strong>
            </div>
            <div class="context-shell-card">
              <p class="context-shell-card__label">Run Progress</p>
              <strong id="card-run-progress">--</strong>
            </div>
            <div class="context-shell-card">
              <p class="context-shell-card__label">Billing</p>
              <strong id="card-billing">--</strong>
            </div>
            <div class="context-shell-card">
              <p class="context-shell-card__label">Pending Confirmations</p>
              <strong id="card-pending-confirmations">--</strong>
            </div>
          </div>
          <div class="context-project" id="context-project">目前專案：未選擇</div>
          <div class="context-tabs" role="tablist" aria-label="右側資訊切換">
            <button type="button" class="context-tab is-active" data-context-tab="context" role="tab" aria-selected="true">Context</button>
            <button type="button" class="context-tab" data-context-tab="graph" role="tab" aria-selected="false">Graph</button>
            <button type="button" class="context-tab" data-context-tab="docs" role="tab" aria-selected="false">Docs</button>
          </div>

          <section class="context-section" data-context-panel="context">
            <h3>Context</h3>
            <p id="context-overview" class="context-overview">請先在上方選擇專案，右側內容會自動同步。</p>
          </section>
          <section class="context-section" data-context-panel="graph" hidden>
            <h3>Graph Preview</h3>
            <div class="graph-toolbar">
              <span id="graph-run-meta" class="graph-run-meta">尚未偵測到 run</span>
              <div class="graph-toolbar__actions">
                <button type="button" class="secondary-btn" id="graph-create-template">Create template</button>
              </div>
            </div>
            <div id="graph-preview" class="graph-preview"></div>
            <ul id="graph-node-list" class="graph-node-list"></ul>
            <pre id="graph-code" class="graph-code"></pre>
          </section>
          <section class="context-section" data-context-panel="docs" hidden>
            <h3>Docs</h3>
            <ul id="docs-list" class="docs-list"></ul>
          </section>
            </aside>
          </div>


          <section class="main-card bill-page" id="bill-page" hidden>
            <header class="bill-page__header">
              <div>
                <h2>Bill</h2>
                <p class="subtitle">顯示今日、專案累計、breakdown、automation/interactive 與 budgets。</p>
              </div>
              <button type="button" class="secondary-btn" id="bill-refresh">重新整理</button>
            </header>

            <div class="bill-kpis">
              <article class="context-shell-card">
                <p class="context-shell-card__label">今日費用 / 用量</p>
                <strong id="bill-today">--</strong>
              </article>
              <article class="context-shell-card">
                <p class="context-shell-card__label">專案累計費用 / 用量</p>
                <strong id="bill-project-total">--</strong>
              </article>
              <article class="context-shell-card">
                <p class="context-shell-card__label">automation / interactive</p>
                <strong id="bill-mode-summary">--</strong>
              </article>
            </div>

            <section class="bill-grid">
              <article class="config-card">
                <h3>Budgets</h3>
                <pre id="bill-budgets">尚未載入。</pre>
              </article>
              <article class="config-card">
                <h3>超限事件（budget_exceeded）</h3>
                <ul id="bill-exceeded" class="logs-list"></ul>
              </article>
            </section>

            <section class="bill-grid">
              <article class="config-card">
                <h3>Breakdown：provider</h3>
                <pre id="bill-breakdown-provider">尚未載入。</pre>
              </article>
              <article class="config-card">
                <h3>Breakdown：model</h3>
                <pre id="bill-breakdown-model">尚未載入。</pre>
              </article>
              <article class="config-card">
                <h3>Breakdown：agent</h3>
                <pre id="bill-breakdown-agent">尚未載入。</pre>
              </article>
              <article class="config-card">
                <h3>Breakdown：node</h3>
                <pre id="bill-breakdown-node">尚未載入。</pre>
              </article>
            </section>
          </section>


          <section class="main-card config-page" id="config-page" hidden>
            <header class="config-page__header">
              <div>
                <h2>Config</h2>
                <p class="subtitle">唯讀檢視 Global / Project / Effective 設定，並顯示 Effective 來源。</p>
              </div>
              <button type="button" class="secondary-btn" id="config-export">匯出 Effective Config</button>
            </header>

            <div class="config-toolbar">
              <label class="field-label config-toolbar__search">
                搜尋 key path
                <input type="search" id="config-search" placeholder="例如：amon.ui.theme" />
              </label>
              <button type="button" class="secondary-btn" id="config-refresh">重新整理</button>
            </div>

            <div class="config-grid">
              <article class="config-card">
                <h3>Global config</h3>
                <pre id="config-global">尚未載入。</pre>
              </article>
              <article class="config-card">
                <h3>Project config</h3>
                <pre id="config-project">尚未載入。</pre>
              </article>
            </div>

            <article class="config-card">
              <h3>Effective config（含來源）</h3>
              <div id="config-effective-summary" class="config-effective-summary">尚未載入。</div>
              <div class="config-table-wrap">
                <table class="config-table" id="config-table">
                  <thead>
                    <tr>
                      <th>Key path</th>
                      <th>Effective</th>
                      <th>Source</th>
                    </tr>
                  </thead>
                  <tbody id="config-table-body"></tbody>
                </table>
              </div>
            </article>
          </section>

          <section class="main-card logs-events-page" id="logs-events-page" hidden>
            <header class="logs-events-page__header">
              <div>
                <h2>Logs &amp; Events</h2>
                <p class="subtitle">依來源與條件檢視 log/event，並支援下載與 drilldown。</p>
              </div>
            </header>

            <section class="logs-panel">
              <h3>Logs</h3>
              <div class="logs-toolbar">
                <label class="field-label">來源
                  <select id="logs-source">
                    <option value="amon">amon</option>
                    <option value="project">project</option>
                    <option value="billing">billing</option>
                  </select>
                </label>
                <label class="field-label">起始時間<input type="datetime-local" id="logs-time-from" /></label>
                <label class="field-label">結束時間<input type="datetime-local" id="logs-time-to" /></label>
                <label class="field-label">project<input type="text" id="logs-filter-project" placeholder="project_id" /></label>
                <label class="field-label">run<input type="text" id="logs-filter-run" placeholder="run_id" /></label>
                <label class="field-label">node<input type="text" id="logs-filter-node" placeholder="node_id" /></label>
                <label class="field-label">severity
                  <select id="logs-filter-severity">
                    <option value="">全部</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                  </select>
                </label>
                <label class="field-label">component<input type="text" id="logs-filter-component" placeholder="component / event" /></label>
                <button type="button" class="secondary-btn" id="logs-refresh">查詢</button>
                <button type="button" class="secondary-btn" id="logs-download">下載</button>
              </div>
              <div id="logs-summary" class="logs-summary">尚未載入。</div>
              <div id="logs-list" class="logs-list"></div>
              <div class="pager" id="logs-pager">
                <button type="button" class="secondary-btn" id="logs-prev">上一頁</button>
                <span id="logs-page-label">第 1 頁</span>
                <button type="button" class="secondary-btn" id="logs-next">下一頁</button>
              </div>
            </section>

            <section class="events-panel">
              <h3>Events</h3>
              <div class="logs-toolbar">
                <label class="field-label">type<input type="text" id="events-filter-type" placeholder="event type" /></label>
                <label class="field-label">起始時間<input type="datetime-local" id="events-time-from" /></label>
                <label class="field-label">結束時間<input type="datetime-local" id="events-time-to" /></label>
                <label class="field-label">project<input type="text" id="events-filter-project" placeholder="project_id" /></label>
                <label class="field-label">run<input type="text" id="events-filter-run" placeholder="run_id" /></label>
                <label class="field-label">node<input type="text" id="events-filter-node" placeholder="node_id" /></label>
                <button type="button" class="secondary-btn" id="events-refresh">查詢</button>
              </div>
              <div id="events-summary" class="logs-summary">尚未載入。</div>
              <div id="events-list" class="logs-list"></div>
              <div class="pager" id="events-pager">
                <button type="button" class="secondary-btn" id="events-prev">上一頁</button>
                <span id="events-page-label">第 1 頁</span>
                <button type="button" class="secondary-btn" id="events-next">下一頁</button>
              </div>
            </section>
          </section>

          <section class="main-card context-page" id="context-page" hidden>
            <header>
              <h2>Context</h2>
              <p class="subtitle">此分頁預留為中心畫面 Context 視圖。</p>
            </header>
            <p class="empty-context">目前尚無可顯示內容。</p>
          </section>

          <section class="main-card graph-page" id="graph-page" hidden>
            <header>
              <h2>Graph</h2>
              <p class="subtitle">此分頁預留為中心畫面 Graph 視圖。</p>
            </header>
            <p class="empty-context">目前尚無可顯示內容。</p>
          </section>

          <section class="main-card docs-page" id="docs-page" hidden>
            <header class="docs-page__header">
              <div>
                <h2>Docs</h2>
                <p class="subtitle">依 run/task 檢視文件，預覽 markdown，並插入 Chat 引用。</p>
              </div>
              <button type="button" class="secondary-btn" id="docs-refresh">重新整理</button>
            </header>
            <div class="docs-layout">
              <aside class="docs-tree" id="docs-tree-wrap">
                <div class="docs-tree__meta" id="docs-tree-meta">尚未載入。</div>
                <div class="docs-tree__viewport" id="docs-tree-viewport" role="list"></div>
              </aside>
              <article class="docs-preview">
                <header class="docs-preview__header">
                  <div>
                    <h3 id="docs-preview-title">請從左側選擇文件</h3>
                    <p id="docs-preview-meta" class="docs-preview__meta">來源 run / node 將顯示於此。</p>
                  </div>
                  <div class="docs-preview__actions">
                    <button type="button" class="secondary-btn" id="docs-open" disabled>Open</button>
                    <button type="button" class="secondary-btn" id="docs-download" disabled>Download</button>
                    <button type="button" class="primary-btn" id="docs-insert" disabled>插入 @doc</button>
                  </div>
                </header>
                <div id="docs-preview-content" class="docs-preview__content">
                  <p class="empty-context">尚未選擇文件。</p>
                </div>
              </article>
            </div>
          </section>

          <section class="main-card tools-skills-page" id="tools-skills-page" hidden>
            <header class="tools-skills-page__header">
              <div>
                <h2>Tools &amp; Skills</h2>
                <p class="subtitle">管理工具與技能清單；所有權限變更都必須經過 Plan Card 確認。</p>
              </div>
              <button type="button" class="secondary-btn" id="tools-skills-refresh">重新整理</button>
            </header>

            <section class="tools-section">
              <h3>Tools</h3>
              <div id="tools-list" class="tools-list"></div>
            </section>

            <section class="skills-section">
              <h3>Skills</h3>
              <div id="skills-collisions" class="skills-collisions"></div>
              <div id="skills-list" class="skills-list"></div>
            </section>

            <section class="skills-preview-section">
              <h3>注入預覽（不觸發模型）</h3>
              <div class="skills-preview-controls">
                <select id="skill-trigger-select"></select>
                <button type="button" class="primary-btn" id="skill-trigger-preview">預覽注入內容</button>
              </div>
              <pre id="skill-injection-preview" class="skill-injection-preview">尚未產生預覽。</pre>
            </section>
          </section>
        </section>
      </div>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <aside id="graph-node-drawer" class="graph-node-drawer" hidden>
      <header class="graph-node-drawer__header">
        <h3 id="graph-node-title">Node 詳細</h3>
        <button type="button" class="secondary-btn" id="graph-node-close">關閉</button>
      </header>
      <div class="graph-node-drawer__meta" id="graph-node-meta"></div>
      <section>
        <h4>inputs</h4>
        <details open>
          <summary>展開內容</summary>
          <pre id="graph-node-inputs" class="graph-node-json"></pre>
        </details>
      </section>
      <section>
        <h4>outputs（docs/artifacts）</h4>
        <pre id="graph-node-outputs" class="graph-node-json"></pre>
      </section>
      <section>
        <h4>最近 events/logs</h4>
        <ul id="graph-node-events" class="graph-node-events"></ul>
      </section>
      <section>
        <h4>Template 化</h4>
        <div class="graph-node-drawer__actions">
          <button type="button" class="secondary-btn" id="graph-parametrize">Parametrize（改成 {{var}}）</button>
        </div>
      </section>
    </aside>

    <script src="/event_stream_client.js"></script>
    <script>
      const { EventStreamClient, createUiEventStore } = window.AmonUIEventStream;
      const state = {
        chatId: null,
        projectId: null,
        plan: null,
        streaming: false,
        attachments: [],
        uiStore: createUiEventStore(),
        streamClient: null,
        graph: null,
        graphRunId: null,
        graphNodeStates: {},
        graphEvents: [],
        graphSelectedNodeId: null,
        graphTemplateId: null,
        shellView: "chat",
        toolsCatalog: [],
        skillsCatalog: [],
        configView: null,
        logsPage: { logsPage: 1, eventsPage: 1, logsHasNext: false, eventsHasNext: false },
        billingSummary: null,
        billingStreamSource: null,
      };

      const elements = {
        projectSelect: document.getElementById("project-select"),
        timeline: document.getElementById("timeline"),
        chatForm: document.getElementById("chat-form"),
        chatInput: document.getElementById("chat-input"),
        chatAttachments: document.getElementById("chat-attachments"),
        attachmentPreview: document.getElementById("attachment-preview"),
        toast: document.getElementById("toast"),
        planCard: document.getElementById("plan-card"),
        planContent: document.getElementById("plan-content"),
        planCommands: document.getElementById("plan-commands"),
        planPatches: document.getElementById("plan-patches"),
        planRisk: document.getElementById("plan-risk"),
        planConfirm: document.getElementById("plan-confirm"),
        planCancel: document.getElementById("plan-cancel"),
        refreshContext: document.getElementById("refresh-context"),
        graphPreview: document.getElementById("graph-preview"),
        graphCode: document.getElementById("graph-code"),
        graphNodeList: document.getElementById("graph-node-list"),
        graphRunMeta: document.getElementById("graph-run-meta"),
        graphCreateTemplate: document.getElementById("graph-create-template"),
        graphNodeDrawer: document.getElementById("graph-node-drawer"),
        graphNodeClose: document.getElementById("graph-node-close"),
        graphNodeTitle: document.getElementById("graph-node-title"),
        graphNodeMeta: document.getElementById("graph-node-meta"),
        graphNodeInputs: document.getElementById("graph-node-inputs"),
        graphNodeOutputs: document.getElementById("graph-node-outputs"),
        graphNodeEvents: document.getElementById("graph-node-events"),
        graphParametrize: document.getElementById("graph-parametrize"),
        docsList: document.getElementById("docs-list"),
        chatProjectLabel: document.getElementById("chat-project-label"),
        contextProject: document.getElementById("context-project"),
        contextOverview: document.getElementById("context-overview"),
        contextTabs: document.querySelectorAll(".context-tab"),
        contextPanels: document.querySelectorAll("[data-context-panel]"),
        streamProgress: document.getElementById("stream-progress"),
        chatLayout: document.getElementById("chat-layout"),
        contextPage: document.getElementById("context-page"),
        graphPage: document.getElementById("graph-page"),
        uiShell: document.getElementById("ui-shell"),
        toggleContextPanel: document.getElementById("toggle-context-panel"),
        shellRunStatus: document.getElementById("shell-run-status"),
        shellDaemonStatus: document.getElementById("shell-daemon-status"),
        shellBudgetStatus: document.getElementById("shell-budget-status"),
        cardRunProgress: document.getElementById("card-run-progress"),
        cardBilling: document.getElementById("card-billing"),
        cardPendingConfirmations: document.getElementById("card-pending-confirmations"),
        thinkingMode: document.getElementById("thinking-mode"),
        thinkingSummary: document.getElementById("thinking-summary"),
        thinkingDetail: document.getElementById("thinking-detail"),
        artifactList: document.getElementById("artifact-list"),
        shellNavItems: document.querySelectorAll(".shell-nav__item"),
        toolsSkillsPage: document.getElementById("tools-skills-page"),
        billPage: document.getElementById("bill-page"),
        billRefresh: document.getElementById("bill-refresh"),
        billToday: document.getElementById("bill-today"),
        billProjectTotal: document.getElementById("bill-project-total"),
        billModeSummary: document.getElementById("bill-mode-summary"),
        billBudgets: document.getElementById("bill-budgets"),
        billExceeded: document.getElementById("bill-exceeded"),
        billBreakdownProvider: document.getElementById("bill-breakdown-provider"),
        billBreakdownModel: document.getElementById("bill-breakdown-model"),
        billBreakdownAgent: document.getElementById("bill-breakdown-agent"),
        billBreakdownNode: document.getElementById("bill-breakdown-node"),
        toolsSkillsRefresh: document.getElementById("tools-skills-refresh"),
        toolsList: document.getElementById("tools-list"),
        skillsList: document.getElementById("skills-list"),
        skillsCollisions: document.getElementById("skills-collisions"),
        skillTriggerSelect: document.getElementById("skill-trigger-select"),
        skillTriggerPreview: document.getElementById("skill-trigger-preview"),
        skillInjectionPreview: document.getElementById("skill-injection-preview"),
        configPage: document.getElementById("config-page"),
        logsEventsPage: document.getElementById("logs-events-page"),
        docsPage: document.getElementById("docs-page"),
        docsRefresh: document.getElementById("docs-refresh"),
        docsTreeMeta: document.getElementById("docs-tree-meta"),
        docsTreeViewport: document.getElementById("docs-tree-viewport"),
        docsPreviewTitle: document.getElementById("docs-preview-title"),
        docsPreviewMeta: document.getElementById("docs-preview-meta"),
        docsPreviewContent: document.getElementById("docs-preview-content"),
        docsOpen: document.getElementById("docs-open"),
        docsDownload: document.getElementById("docs-download"),
        docsInsert: document.getElementById("docs-insert"),
        logsSource: document.getElementById("logs-source"),
        logsTimeFrom: document.getElementById("logs-time-from"),
        logsTimeTo: document.getElementById("logs-time-to"),
        logsFilterProject: document.getElementById("logs-filter-project"),
        logsFilterRun: document.getElementById("logs-filter-run"),
        logsFilterNode: document.getElementById("logs-filter-node"),
        logsFilterSeverity: document.getElementById("logs-filter-severity"),
        logsFilterComponent: document.getElementById("logs-filter-component"),
        logsRefresh: document.getElementById("logs-refresh"),
        logsDownload: document.getElementById("logs-download"),
        logsSummary: document.getElementById("logs-summary"),
        logsList: document.getElementById("logs-list"),
        logsPrev: document.getElementById("logs-prev"),
        logsNext: document.getElementById("logs-next"),
        logsPageLabel: document.getElementById("logs-page-label"),
        eventsFilterType: document.getElementById("events-filter-type"),
        eventsTimeFrom: document.getElementById("events-time-from"),
        eventsTimeTo: document.getElementById("events-time-to"),
        eventsFilterProject: document.getElementById("events-filter-project"),
        eventsFilterRun: document.getElementById("events-filter-run"),
        eventsFilterNode: document.getElementById("events-filter-node"),
        eventsRefresh: document.getElementById("events-refresh"),
        eventsSummary: document.getElementById("events-summary"),
        eventsList: document.getElementById("events-list"),
        eventsPrev: document.getElementById("events-prev"),
        eventsNext: document.getElementById("events-next"),
        eventsPageLabel: document.getElementById("events-page-label"),
        configRefresh: document.getElementById("config-refresh"),
        configSearch: document.getElementById("config-search"),
        configExport: document.getElementById("config-export"),
        configGlobal: document.getElementById("config-global"),
        configProject: document.getElementById("config-project"),
        configEffectiveSummary: document.getElementById("config-effective-summary"),
        configTableBody: document.getElementById("config-table-body"),
      };

      function syncContextPanelToggle() {
        if (!elements.uiShell || !elements.toggleContextPanel) {
          return;
        }
        const collapsed = elements.uiShell.classList.contains("is-context-collapsed");
        elements.toggleContextPanel.textContent = collapsed ? "展開右側面板" : "收合右側面板";
        elements.toggleContextPanel.setAttribute("aria-expanded", String(!collapsed));
      }

      elements.toggleContextPanel?.addEventListener("click", () => {
        elements.uiShell?.classList.toggle("is-context-collapsed");
        syncContextPanelToggle();
      });

      syncContextPanelToggle();

      function switchShellView(view) {
        if (view !== "bill") {
          closeBillingStream();
        }
        state.shellView = view;
        elements.chatLayout.hidden = view !== "chat";
        elements.contextPage.hidden = view !== "context";
        elements.graphPage.hidden = view !== "graph";
        elements.toolsSkillsPage.hidden = view !== "tools-skills";
        elements.billPage.hidden = view !== "bill";
        elements.configPage.hidden = view !== "config";
        elements.logsEventsPage.hidden = view !== "logs-events";
        elements.docsPage.hidden = view !== "docs";
      }

      function formatConfigCell(value) {
        if (value === undefined) return "-";
        if (value === null) return "null";
        if (typeof value === "string") return value;
        return JSON.stringify(value);
      }

      function flattenConfigRows(effective, sources, prefix = "") {
        if (!effective || typeof effective !== "object" || Array.isArray(effective)) {
          return [{ keyPath: prefix || "(root)", effective, source: sources || "default" }];
        }
        const rows = [];
        Object.entries(effective).forEach(([key, value]) => {
          const keyPath = prefix ? `${prefix}.${key}` : key;
          const sourceValue = sources && typeof sources === "object" ? sources[key] : undefined;
          if (value && typeof value === "object" && !Array.isArray(value)) {
            rows.push(...flattenConfigRows(value, sourceValue, keyPath));
            return;
          }
          rows.push({ keyPath, effective: value, source: sourceValue || "default" });
        });
        return rows;
      }

      function renderConfigTable() {
        const payload = state.configView;
        if (!payload) {
          elements.configGlobal.textContent = "尚未載入。";
          elements.configProject.textContent = "尚未載入。";
          elements.configEffectiveSummary.textContent = "尚未載入。";
          elements.configTableBody.innerHTML = "";
          return;
        }
        elements.configGlobal.textContent = JSON.stringify(payload.global_config || {}, null, 2);
        elements.configProject.textContent = JSON.stringify(payload.project_config || {}, null, 2);

        const keyword = (elements.configSearch.value || "").trim().toLowerCase();
        const rows = flattenConfigRows(payload.effective_config || {}, payload.sources || {});
        const filtered = keyword ? rows.filter((row) => row.keyPath.toLowerCase().includes(keyword)) : rows;
        elements.configEffectiveSummary.textContent = `共 ${rows.length} 筆 leaf 設定，篩選後 ${filtered.length} 筆。來源包含：default / global / project / cli / chat。`;
        elements.configTableBody.innerHTML = "";

        filtered.forEach((row) => {
          const tr = document.createElement("tr");
          const sourceLabel = ["default", "global", "project", "cli", "chat"].includes(row.source) ? row.source : "default";
          tr.innerHTML = `
            <td><code>${escapeHtml(row.keyPath)}</code></td>
            <td><code>${escapeHtml(formatConfigCell(row.effective))}</code></td>
            <td><span class="config-source config-source--${sourceLabel}">${sourceLabel}</span></td>
          `;
          elements.configTableBody.appendChild(tr);
        });
      }

      async function loadConfigPage() {
        const projectParam = state.projectId ? `?project_id=${encodeURIComponent(state.projectId)}` : "";
        const payload = await apiFetch(`/config/view${projectParam}`);
        state.configView = payload;
        renderConfigTable();
      }

      function formatBillMetric(cost, usage, currency) {
        return `${currency} ${Number(cost || 0).toFixed(2)} / ${Number(usage || 0).toFixed(2)}`;
      }

      function formatBreakdown(payload = {}) {
        const entries = Object.entries(payload || {});
        if (!entries.length) return "尚無資料";
        return entries
          .sort((a, b) => Number(b[1]?.cost || 0) - Number(a[1]?.cost || 0))
          .map(
            ([key, value]) =>
              `${key}\n  cost: ${Number(value?.cost || 0).toFixed(4)}\n  usage: ${Number(value?.usage || 0).toFixed(4)}\n  records: ${Number(value?.records || 0)}`
          )
          .join("\n\n");
      }

      function renderBillPage() {
        const payload = state.billingSummary;
        if (!payload) {
          elements.billToday.textContent = "--";
          elements.billProjectTotal.textContent = "--";
          elements.billModeSummary.textContent = "--";
          elements.billBudgets.textContent = "尚未載入。";
          elements.billExceeded.innerHTML = "";
          elements.billBreakdownProvider.textContent = "尚未載入。";
          elements.billBreakdownModel.textContent = "尚未載入。";
          elements.billBreakdownAgent.textContent = "尚未載入。";
          elements.billBreakdownNode.textContent = "尚未載入。";
          return;
        }
        const currency = payload.currency || "USD";
        elements.billToday.textContent = formatBillMetric(payload.today?.cost, payload.today?.usage, currency);
        elements.billProjectTotal.textContent = formatBillMetric(payload.project_total?.cost, payload.project_total?.usage, currency);
        elements.billModeSummary.textContent = `automation ${formatBillMetric(payload.mode_breakdown?.automation?.cost, payload.mode_breakdown?.automation?.usage, currency)}｜interactive ${formatBillMetric(payload.mode_breakdown?.interactive?.cost, payload.mode_breakdown?.interactive?.usage, currency)}`;
        elements.billBudgets.textContent = JSON.stringify(payload.budgets || {}, null, 2);
        elements.billBreakdownProvider.textContent = formatBreakdown(payload.breakdown?.provider);
        elements.billBreakdownModel.textContent = formatBreakdown(payload.breakdown?.model);
        elements.billBreakdownAgent.textContent = formatBreakdown(payload.breakdown?.agent);
        elements.billBreakdownNode.textContent = formatBreakdown(payload.breakdown?.node);

        elements.billExceeded.innerHTML = "";
        (payload.exceeded_events || []).forEach((event) => {
          const card = document.createElement("article");
          card.className = "log-item";
          card.innerHTML = `<header><strong>budget_exceeded</strong> · <code>${escapeHtml(event.ts || "-")}</code></header><pre>${escapeHtml(JSON.stringify(event, null, 2))}</pre>`;
          elements.billExceeded.appendChild(card);
        });
        if (!payload.exceeded_events || !payload.exceeded_events.length) {
          elements.billExceeded.textContent = "目前沒有超限事件。";
        }
      }

      function closeBillingStream() {
        if (state.billingStreamSource) {
          state.billingStreamSource.close();
          state.billingStreamSource = null;
        }
      }

      function openBillingStream() {
        closeBillingStream();
        const params = new URLSearchParams();
        if (state.projectId) {
          params.set("project_id", state.projectId);
        }
        const source = new EventSource(`/v1/billing/stream?${params.toString()}`);
        source.addEventListener("usage_updated", (event) => {
          state.billingSummary = JSON.parse(event.data || "{}");
          renderBillPage();
        });
        source.addEventListener("budget_exceeded", () => {
          showToast("偵測到 budget_exceeded 事件，已同步 Bill。", 4500);
        });
        source.onerror = () => {
          closeBillingStream();
        };
        state.billingStreamSource = source;
      }

      async function loadBillPage() {
        const projectParam = state.projectId ? `?project_id=${encodeURIComponent(state.projectId)}` : "";
        const payload = await apiFetch(`/billing/summary${projectParam}`);
        state.billingSummary = payload;
        renderBillPage();
        openBillingStream();
      }

      function exportEffectiveConfig() {
        if (!state.configView) {
          showToast("請先載入 Config。");
          return;
        }
        const blob = new Blob([JSON.stringify(state.configView.effective_config || {}, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        const projectSuffix = state.projectId ? `-${state.projectId}` : "-global";
        link.href = url;
        link.download = `amon-effective-config${projectSuffix}.json`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      }

      function fromDateInput(value) {
        if (!value) return "";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "";
        return date.toISOString();
      }

      function buildLogsQuery(page) {
        const params = new URLSearchParams({ source: elements.logsSource.value, page: String(page), page_size: "50" });
        [
          ["project_id", elements.logsFilterProject.value || state.projectId || ""],
          ["run_id", elements.logsFilterRun.value],
          ["node_id", elements.logsFilterNode.value],
          ["severity", elements.logsFilterSeverity.value],
          ["component", elements.logsFilterComponent.value],
          ["time_from", fromDateInput(elements.logsTimeFrom.value)],
          ["time_to", fromDateInput(elements.logsTimeTo.value)],
        ].forEach(([key, value]) => {
          if (value) params.set(key, value);
        });
        return params;
      }

      function buildEventsQuery(page) {
        const params = new URLSearchParams({ page: String(page), page_size: "50" });
        [
          ["project_id", elements.eventsFilterProject.value || state.projectId || ""],
          ["run_id", elements.eventsFilterRun.value],
          ["node_id", elements.eventsFilterNode.value],
          ["type", elements.eventsFilterType.value],
          ["time_from", fromDateInput(elements.eventsTimeFrom.value)],
          ["time_to", fromDateInput(elements.eventsTimeTo.value)],
        ].forEach(([key, value]) => {
          if (value) params.set(key, value);
        });
        return params;
      }

      function renderLogsPage(payload) {
        elements.logsList.innerHTML = "";
        elements.logsSummary.textContent = `共 ${payload.total} 筆，顯示第 ${payload.page} 頁。`;
        elements.logsPageLabel.textContent = `第 ${payload.page} 頁`;
        elements.logsPrev.disabled = payload.page <= 1;
        elements.logsNext.disabled = !payload.has_next;
        payload.items.forEach((item) => {
          const card = document.createElement("article");
          card.className = "log-item";
          card.innerHTML = `
            <header><strong>${escapeHtml(item.level || item.severity || "INFO")}</strong> · <code>${escapeHtml(item.ts || "-")}</code></header>
            <div class="log-item__meta">${escapeHtml(item.project_id || "-")} / ${escapeHtml(item.run_id || "-")} / ${escapeHtml(item.node_id || "-")}</div>
            <pre>${escapeHtml(JSON.stringify(item, null, 2))}</pre>
          `;
          elements.logsList.appendChild(card);
        });
        if (!payload.items.length) {
          elements.logsList.textContent = "查無資料";
        }
      }

      function renderEventsPage(payload) {
        elements.eventsList.innerHTML = "";
        elements.eventsSummary.textContent = `共 ${payload.total} 筆，顯示第 ${payload.page} 頁。`;
        elements.eventsPageLabel.textContent = `第 ${payload.page} 頁`;
        elements.eventsPrev.disabled = payload.page <= 1;
        elements.eventsNext.disabled = !payload.has_next;
        payload.items.forEach((item) => {
          const card = document.createElement("article");
          card.className = "log-item";
          const eventType = item.event || item.type || "unknown";
          card.innerHTML = `
            <header><strong>${escapeHtml(eventType)}</strong> · <code>${escapeHtml(item.ts || "-")}</code></header>
            <div class="log-item__meta">${escapeHtml(item.project_id || "-")} / ${escapeHtml(item.run_id || "-")} / ${escapeHtml(item.node_id || "-")}</div>
            <pre>${escapeHtml(JSON.stringify(item, null, 2))}</pre>
          `;
          const drilldown = document.createElement("div");
          drilldown.className = "log-item__actions";
          ["run_id", "node_id", "hook_id", "schedule_id", "job_id"].forEach((key) => {
            const value = item.drilldown && item.drilldown[key];
            if (!value) return;
            const button = document.createElement("button");
            button.type = "button";
            button.className = "secondary-btn";
            button.textContent = `前往 ${key.replace("_id", "")}：${value}`;
            button.addEventListener("click", async () => {
              if (item.project_id) {
                setProjectState(item.project_id);
                await loadContext();
              }
              switchShellView("chat");
              showToast(`已切換至 Chat，可依 ${key}=${value} 追蹤。`);
            });
            drilldown.appendChild(button);
          });
          card.appendChild(drilldown);
          elements.eventsList.appendChild(card);
        });
        if (!payload.items.length) {
          elements.eventsList.textContent = "查無資料";
        }
      }

      async function loadLogsPage(page = 1) {
        const payload = await apiFetch(`/logs/query?${buildLogsQuery(page).toString()}`);
        state.logsPage.logsPage = payload.page;
        state.logsPage.logsHasNext = payload.has_next;
        renderLogsPage(payload);
      }

      async function loadEventsPage(page = 1) {
        const payload = await apiFetch(`/events/query?${buildEventsQuery(page).toString()}`);
        state.logsPage.eventsPage = payload.page;
        state.logsPage.eventsHasNext = payload.has_next;
        renderEventsPage(payload);
      }

      async function loadLogsEventsPage() {
        if (!elements.logsFilterProject.value && state.projectId) {
          elements.logsFilterProject.value = state.projectId;
        }
        if (!elements.eventsFilterProject.value && state.projectId) {
          elements.eventsFilterProject.value = state.projectId;
        }
        await Promise.all([loadLogsPage(1), loadEventsPage(1)]);
      }

      async function loadToolsSkillsPage() {
        const projectParam = state.projectId ? `?project_id=${encodeURIComponent(state.projectId)}` : "";
        const toolsPayload = await apiFetch(`/tools/catalog${projectParam}`);
        const skillsPayload = await apiFetch(`/skills/catalog${projectParam}`);
        state.toolsCatalog = toolsPayload.tools || [];
        state.skillsCatalog = skillsPayload.skills || [];
        renderToolsList(state.toolsCatalog, toolsPayload.policy_editable);
        renderSkillsList(state.skillsCatalog, skillsPayload.collisions || []);
      }

      function formatRecentUsage(usage) {
        if (!usage || !usage.ts_ms) return "尚無紀錄";
        const dt = new Date(usage.ts_ms);
        return `${dt.toLocaleString("zh-TW", { hour12: false })} (${usage.decision || "unknown"})`;
      }

      function renderSchema(schema) {
        return `<pre>${escapeHtml(JSON.stringify(schema || {}, null, 2))}</pre>`;
      }

      function queueToolPolicyPlan(toolName, action, requireConfirm) {
        apiFetch("/tools/policy/plan", {
          method: "POST",
          body: JSON.stringify({ tool_name: toolName, action, require_confirm: requireConfirm }),
        })
          .then((payload) => {
            showPlanCard({
              ...payload.plan,
              confirm_api: "/tools/policy/confirm",
            });
          })
          .catch((error) => showToast(`建立 Plan Card 失敗：${error.message}`));
      }

      function renderToolsList(tools = [], policyEditable = false) {
        elements.toolsList.innerHTML = "";
        if (!tools.length) {
          elements.toolsList.innerHTML = '<p class="empty-context">尚未找到工具。</p>';
          return;
        }
        tools.forEach((tool) => {
          const card = document.createElement("article");
          card.className = "tool-card";
          card.innerHTML = `
            <header>
              <div>
                <strong>${escapeHtml(tool.name)}</strong>
                <p>${escapeHtml(tool.type)} ｜ v${escapeHtml(String(tool.version || "unknown"))}</p>
              </div>
              <span class="risk-chip">risk: ${escapeHtml(String(tool.risk || "unknown"))}</span>
            </header>
            <p>allowed_paths：${escapeHtml((tool.allowed_paths || []).join(", ") || "workspace")}</p>
            <p>最近使用：${escapeHtml(formatRecentUsage(tool.recent_usage))}</p>
            <details><summary>inputs schema</summary>${renderSchema(tool.input_schema)}</details>
            <details><summary>outputs schema</summary>${renderSchema(tool.output_schema)}</details>
          `;
          const actions = document.createElement("div");
          actions.className = "tool-card__actions";
          if (policyEditable) {
            const enableButton = document.createElement("button");
            enableButton.type = "button";
            enableButton.className = "secondary-btn small";
            enableButton.textContent = tool.enabled ? "Disable" : "Enable";
            enableButton.addEventListener("click", () => queueToolPolicyPlan(tool.name, tool.enabled ? "disable" : "enable", Boolean(tool.require_confirm)));
            actions.appendChild(enableButton);

            const confirmButton = document.createElement("button");
            confirmButton.type = "button";
            confirmButton.className = "secondary-btn small";
            confirmButton.textContent = `Require Confirm：${tool.require_confirm ? "ON" : "OFF"}`;
            confirmButton.addEventListener("click", () => queueToolPolicyPlan(tool.name, "require_confirm", !tool.require_confirm));
            actions.appendChild(confirmButton);
          }
          card.appendChild(actions);
          elements.toolsList.appendChild(card);
        });
      }

      function renderSkillsList(skills = [], collisions = []) {
        elements.skillsList.innerHTML = "";
        elements.skillsCollisions.innerHTML = "";
        if (collisions.length) {
          collisions.forEach((item) => {
            const tip = document.createElement("p");
            tip.className = "collision-tip";
            tip.textContent = `⚠️ ${item.name}：${item.message}`;
            elements.skillsCollisions.appendChild(tip);
          });
        }
        if (!skills.length) {
          elements.skillsList.innerHTML = '<p class="empty-context">尚未找到 skills。</p>';
          return;
        }
        elements.skillTriggerSelect.innerHTML = "";
        skills.forEach((skill) => {
          const card = document.createElement("article");
          card.className = "skill-card";
          const frontmatter = skill.frontmatter || {};
          card.innerHTML = `
            <header><strong>${escapeHtml(skill.name || "(未命名)")}</strong><span>${escapeHtml(skill.source || "unknown")}</span></header>
            <p>${escapeHtml(frontmatter.description || skill.description || "無描述")}</p>
            <p class="skill-source">來源：${escapeHtml(skill.path || "")}</p>
            <pre>${escapeHtml(JSON.stringify({ name: frontmatter.name || skill.name, description: frontmatter.description || "" }, null, 2))}</pre>
          `;
          elements.skillsList.appendChild(card);

          const option = document.createElement("option");
          option.value = skill.name || "";
          option.textContent = `${skill.name || "(未命名)"}（${skill.source || "unknown"}）`;
          elements.skillTriggerSelect.appendChild(option);
        });
      }

      function showToast(message) {
        elements.toast.textContent = message;
        elements.toast.classList.add("visible");
        window.clearTimeout(elements.toast._timer);
        elements.toast._timer = window.setTimeout(() => {
          elements.toast.classList.remove("visible");
        }, 9000);
      }

      function renderStoreSummary(storeState) {
        const runStatus = storeState.run?.status || (state.streaming ? "streaming" : "idle");
        const runProgress = storeState.run?.progress;
        if (!elements.shellRunStatus || !elements.cardRunProgress || !elements.cardBilling || !elements.shellBudgetStatus || !elements.cardPendingConfirmations) {
          return;
        }
        elements.shellRunStatus.textContent = `Run：${runStatus}`;
        elements.cardRunProgress.textContent = Number.isFinite(runProgress) ? `${runProgress}%` : "--";
        elements.cardBilling.textContent = `NT$ ${storeState.billing.total_cost.toFixed(2)}`;
        elements.shellBudgetStatus.textContent = `Budget：NT$ ${storeState.billing.total_cost.toFixed(2)} / NT$ 5,000`;
        const pendingJobs = Object.values(storeState.jobs).filter((job) => job.status && job.status !== "completed").length;
        elements.cardPendingConfirmations.textContent = pendingJobs > 0 ? `${pendingJobs} 項任務進行中` : "0";
      }

      state.uiStore.subscribe((snapshot) => {
        renderStoreSummary(snapshot);
        if (snapshot.docs.length > 0) {
          renderDocs(snapshot.docs);
        }
      });
      renderStoreSummary(state.uiStore.getState());

      async function apiFetch(path, options = {}) {
        const response = await fetch(`/v1${path}`, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        let payload = {};
        try {
          payload = await response.json();
        } catch (error) {
          payload = {};
        }
        if (!response.ok) {
          throw new Error(payload.message || "API 發生錯誤");
        }
        return payload;
      }

      function appendMessage(role, text, meta = {}) {
        const row = document.createElement("article");
        row.className = "timeline-row";

        const bubble = document.createElement("div");
        bubble.className = `chat-bubble ${role}`;
        bubble.innerHTML = renderMarkdown(text);

        const footer = document.createElement("footer");
        footer.className = "timeline-meta";
        const roleLabel = role === "user" ? "你" : "Amon";
        const status = meta.status ? `・${meta.status}` : "";
        footer.textContent = `${new Date().toLocaleTimeString("zh-TW", { hour12: false })}・${roleLabel}${status}`;

        row.appendChild(bubble);
        row.appendChild(footer);
        elements.timeline.appendChild(row);
        elements.timeline.scrollTop = elements.timeline.scrollHeight;
        return bubble;
      }

      function appendTimelineStatus(message) {
        const item = document.createElement("div");
        item.className = "timeline-status";
        item.textContent = message;
        elements.timeline.appendChild(item);
        elements.timeline.scrollTop = elements.timeline.scrollHeight;
      }


      function appendRestoredMessage(role, text, ts = "") {
        const row = document.createElement("article");
        row.className = "timeline-row";

        const bubble = document.createElement("div");
        bubble.className = `chat-bubble ${role}`;
        const prefix = role === "user" ? "你：" : "Amon：";
        bubble.innerHTML = renderMarkdown(`${prefix}${text}`);

        const footer = document.createElement("footer");
        footer.className = "timeline-meta";
        const roleLabel = role === "user" ? "你" : "Amon";
        footer.textContent = ts ? `${ts}・${roleLabel}` : roleLabel;

        row.appendChild(bubble);
        row.appendChild(footer);
        elements.timeline.appendChild(row);
      }

      async function loadProjectHistory() {
        elements.timeline.innerHTML = "";
        if (!state.projectId) {
          appendTimelineStatus("目前為無專案模式。輸入任務後會自動建立新專案並切換。");
          return;
        }
        const payload = await apiFetch(`/projects/${encodeURIComponent(state.projectId)}/chat-history`);
        state.chatId = payload.chat_id || state.chatId;
        const messages = Array.isArray(payload.messages) ? payload.messages : [];
        if (!messages.length) {
          appendTimelineStatus("目前尚無歷史對話。請直接輸入需求開始。");
          return;
        }
        messages.forEach((item) => {
          const role = item.role === "user" ? "user" : "agent";
          appendRestoredMessage(role, item.text || "", item.ts || "");
        });
        elements.timeline.scrollTop = elements.timeline.scrollHeight;
      }

      function collectArtifactsFromNodeStates(nodeStates = {}) {
        const artifacts = [];
        Object.entries(nodeStates || {}).forEach(([nodeId, nodeState]) => {
          const output = nodeState && typeof nodeState === "object" ? nodeState.output : null;
          if (!output || typeof output !== "object") {
            return;
          }
          const entries = [];
          if (Array.isArray(output.artifacts)) {
            entries.push(...output.artifacts);
          }
          if (Array.isArray(output.docs)) {
            entries.push(...output.docs);
          }
          if (typeof output.path === "string") {
            entries.push({ path: output.path });
          }
          entries.forEach((item) => {
            if (typeof item === "string") {
              artifacts.push({ type: "artifact", run_id: state.graphRunId || "unknown", node_id: nodeId, path: item, preview: "" });
              return;
            }
            if (item && typeof item === "object" && item.path) {
              artifacts.push({
                type: item.type || "artifact",
                run_id: item.run_id || state.graphRunId || "unknown",
                node_id: item.node_id || nodeId,
                path: item.path,
                preview: item.preview || "",
              });
            }
          });
        });
        return artifacts;
      }

      function escapeHtml(text) {
        return text
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function renderInlineMarkdown(text) {
        let html = escapeHtml(text);
        html = html.replace(/`([^`]+)`/g, "<code>$1</code>");
        html = html.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        html = html.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        return html;
      }

      function renderMarkdown(text) {
        const lines = String(text || "").split("\n");
        const html = [];
        let inList = false;
        let inCodeBlock = false;
        let codeLines = [];
        let paragraph = [];

        const flushParagraph = () => {
          if (!paragraph.length) return;
          html.push(`<p>${renderInlineMarkdown(paragraph.join("\n")).replaceAll("\n", "<br />")}</p>`);
          paragraph = [];
        };

        const flushCodeBlock = () => {
          if (!inCodeBlock) return;
          html.push(`<pre><code>${escapeHtml(codeLines.join("\n"))}</code></pre>`);
          inCodeBlock = false;
          codeLines = [];
        };

        const closeList = () => {
          if (!inList) return;
          html.push("</ul>");
          inList = false;
        };

        lines.forEach((rawLine) => {
          const line = rawLine.trimEnd();
          if (line.trim().startsWith("```")) {
            flushParagraph();
            closeList();
            if (inCodeBlock) {
              flushCodeBlock();
            } else {
              inCodeBlock = true;
              codeLines = [];
            }
            return;
          }

          if (inCodeBlock) {
            codeLines.push(rawLine);
            return;
          }

          if (!line.trim()) {
            flushParagraph();
            closeList();
            return;
          }

          const headingMatch = line.match(/^(#{1,3})\s+(.+)$/);
          if (headingMatch) {
            flushParagraph();
            closeList();
            const level = headingMatch[1].length;
            html.push(`<h${level}>${renderInlineMarkdown(headingMatch[2])}</h${level}>`);
            return;
          }

          const listMatch = line.match(/^[-*]\s+(.+)$/);
          if (listMatch) {
            flushParagraph();
            if (!inList) {
              html.push("<ul>");
              inList = true;
            }
            html.push(`<li>${renderInlineMarkdown(listMatch[1])}</li>`);
            return;
          }

          closeList();
          paragraph.push(line);
        });

        flushParagraph();
        closeList();
        flushCodeBlock();
        return html.join("");
      }

      function setStreaming(active) {
        state.streaming = active;
        elements.streamProgress.hidden = !active;
        elements.chatInput.disabled = active;
      }

      function resetPlanCard() {
        state.plan = null;
        elements.planCard.hidden = true;
        elements.planContent.textContent = "";
        elements.planCommands.innerHTML = "";
        elements.planPatches.innerHTML = "";
        elements.planRisk.innerHTML = "";
      }

      function setProjectState(projectId) {
        state.projectId = projectId || null;
        elements.refreshContext.disabled = !state.projectId;
        if (state.projectId && !elements.projectSelect.querySelector(`option[value="${CSS.escape(state.projectId)}"]`)) {
          const dynamicOption = document.createElement("option");
          dynamicOption.value = state.projectId;
          dynamicOption.textContent = `新專案（${state.projectId}）`;
          dynamicOption.dataset.dynamic = "true";
          elements.projectSelect.appendChild(dynamicOption);
        }
        elements.projectSelect.value = projectId || "";
        syncContextHeader();
        if (!state.projectId) {
          state.chatId = null;
          elements.timeline.innerHTML = "";
          renderArtifacts([]);
          elements.graphPreview.innerHTML = "<p class=\"empty-context\">請先在上方選擇專案。</p>";
          elements.graphCode.textContent = "";
          elements.contextOverview.textContent = "請先在上方選擇專案，右側內容會自動同步。";
          renderDocs([]);
        }
      }

      function syncContextHeader() {
        const selected = elements.projectSelect.selectedOptions[0]?.textContent || "未指定專案";
        elements.contextProject.textContent = `目前專案：${selected}`;
        elements.chatProjectLabel.textContent = `目前專案：${selected}`;
      }

      function switchContextTab(tabName) {
        elements.contextTabs.forEach((tab) => {
          const isActive = tab.dataset.contextTab === tabName;
          tab.classList.toggle("is-active", isActive);
          tab.setAttribute("aria-selected", String(isActive));
        });
        elements.contextPanels.forEach((panel) => {
          panel.hidden = panel.dataset.contextPanel !== tabName;
        });
      }

      async function loadProjects() {
        let projects = [];
        try {
          const payload = await apiFetch("/projects");
          projects = payload.projects || [];
        } catch (error) {
          throw error;
        }
        elements.projectSelect.innerHTML = "";
        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = "無專案";
        elements.projectSelect.appendChild(emptyOption);
        projects.forEach((project) => {
          const option = document.createElement("option");
          option.value = project.project_id;
          option.textContent = `${project.name}（${project.project_id}）`;
          elements.projectSelect.appendChild(option);
        });
        const availableIds = new Set(projects.map((project) => project.project_id));
        if (state.projectId && !availableIds.has(state.projectId)) {
          state.projectId = null;
        }
        elements.projectSelect.value = state.projectId || "";
        syncContextHeader();
        if (!projects.length) {
          showToast("尚無專案，請在聊天輸入：建立專案 <名稱>");
        }
        elements.refreshContext.disabled = !state.projectId;
      }

      async function ensureChatSession() {
        if (!state.projectId) return;
        const payload = await apiFetch("/chat/sessions", {
          method: "POST",
          body: JSON.stringify({ project_id: state.projectId }),
        });
        state.chatId = payload.chat_id;
      }

      async function loadContext() {
        if (!state.projectId) {
          showToast("請先選擇專案。");
          return;
        }
        const payload = await apiFetch(`/projects/${encodeURIComponent(state.projectId)}/context`);
        state.graph = payload.graph || { nodes: [], edges: [] };
        state.graphRunId = payload.run_id || null;
        state.graphNodeStates = payload.node_states || {};
        state.graphEvents = payload.recent_events || [];
        elements.graphCode.textContent = payload.graph_mermaid || "";
        renderGraph(payload.graph_mermaid || "");
        renderNodeList();
        elements.graphRunMeta.textContent = state.graphRunId
          ? `Run：${state.graphRunId}（${payload.run_status || "unknown"}）`
          : "尚未偵測到 run";
        renderDocs(payload.docs || []);
        const docCount = (payload.docs || []).length;
        const hasGraph = payload.graph_mermaid ? "有" : "無";
        elements.contextOverview.textContent = `已同步專案內容：Graph ${hasGraph}、文件 ${docCount} 筆。`;
        renderArtifacts(collectArtifactsFromNodeStates(state.graphNodeStates));
      }

      function normalizeDocItem(doc) {
        if (typeof doc === "string") {
          return {
            path: doc,
            name: doc.split("/").pop() || doc,
            run_id: "unknown",
            node_id: "unknown",
            task_id: "ungrouped",
            open_url: null,
            download_url: null,
          };
        }
        return {
          path: doc.path || "",
          name: doc.name || (doc.path || "").split("/").pop() || "(未命名)",
          run_id: doc.run_id || "unknown",
          node_id: doc.node_id || "unknown",
          task_id: doc.task_id || "ungrouped",
          open_url: doc.open_url || null,
          download_url: doc.download_url || null,
        };
      }

      function renderDocs(docs) {
        elements.docsList.innerHTML = "";
        const normalized = (docs || []).map(normalizeDocItem);
        state.docsItems = normalized;
        if (!normalized.length) {
          state.docsSelectedPath = null;
          elements.docsOpen.disabled = true;
          elements.docsDownload.disabled = true;
          elements.docsInsert.disabled = true;
          elements.docsPreviewTitle.textContent = "請從左側選擇文件";
          elements.docsPreviewMeta.textContent = "來源 run / node 將顯示於此。";
          elements.docsPreviewContent.innerHTML = '<p class="empty-context">尚未選擇文件。</p>';
          const item = document.createElement("li");
          item.textContent = state.projectId ? "尚無文件" : "請先選擇專案";
          elements.docsList.appendChild(item);
          return;
        }
        normalized.slice(0, 8).forEach((doc) => {
          const item = document.createElement("li");
          item.textContent = doc.path;
          elements.docsList.appendChild(item);
        });
      }

      function buildDocsTree(items = []) {
        const grouped = new Map();
        items.forEach((doc) => {
          const runKey = `run:${doc.run_id || "unknown"}`;
          if (!grouped.has(runKey)) {
            grouped.set(runKey, { type: "group", key: runKey, label: `Run ${doc.run_id || "unknown"}` });
          }
          const taskKey = `${runKey}/task:${doc.task_id || "ungrouped"}`;
          if (!grouped.has(taskKey)) {
            grouped.set(taskKey, { type: "group", key: taskKey, label: `Task ${doc.task_id || "ungrouped"}`, depth: 1 });
          }
        });

        const flat = [];
        Array.from(grouped.values()).forEach((entry) => {
          if (entry.depth !== 1) {
            flat.push({ ...entry, depth: 0 });
            Array.from(grouped.values())
              .filter((task) => task.depth === 1 && task.key.startsWith(entry.key))
              .forEach((task) => {
                flat.push(task);
                items
                  .filter((doc) => task.key === `run:${doc.run_id || "unknown"}/task:${doc.task_id || "ungrouped"}`)
                  .forEach((doc) => {
                    flat.push({ type: "doc", depth: 2, key: doc.path, doc });
                  });
              });
          }
        });
        return flat;
      }

      function renderDocsVirtualList() {
        const viewport = elements.docsTreeViewport;
        const total = state.docsFlatItems.length;
        if (!total) {
          viewport.innerHTML = '<p class="empty-context">尚無文件可顯示。</p>';
          return;
        }
        const rowHeight = state.docsVirtual.rowHeight;
        const scrollTop = viewport.scrollTop;
        const startIndex = Math.max(0, Math.floor(scrollTop / rowHeight) - state.docsVirtual.buffer);
        const visibleCount = Math.ceil(viewport.clientHeight / rowHeight) + state.docsVirtual.buffer * 2;
        const endIndex = Math.min(total, startIndex + visibleCount);

        const spacerTop = startIndex * rowHeight;
        const spacerBottom = Math.max(0, (total - endIndex) * rowHeight);

        const fragment = document.createDocumentFragment();
        if (spacerTop > 0) {
          const top = document.createElement("div");
          top.style.height = `${spacerTop}px`;
          fragment.appendChild(top);
        }

        state.docsFlatItems.slice(startIndex, endIndex).forEach((item) => {
          const row = document.createElement("button");
          row.type = "button";
          row.className = `docs-row docs-row--${item.type}`;
          row.style.paddingLeft = `${12 + item.depth * 16}px`;
          row.setAttribute("role", "listitem");
          if (item.type === "doc") {
            row.textContent = `${item.doc.name} · ${item.doc.node_id}`;
            row.classList.toggle("is-active", state.docsSelectedPath === item.doc.path);
            row.addEventListener("click", () => selectDoc(item.doc.path));
          } else {
            row.disabled = true;
            row.textContent = item.label;
          }
          fragment.appendChild(row);
        });

        if (spacerBottom > 0) {
          const bottom = document.createElement("div");
          bottom.style.height = `${spacerBottom}px`;
          fragment.appendChild(bottom);
        }

        viewport.replaceChildren(fragment);
      }

      function getSelectedDoc() {
        return state.docsItems.find((item) => item.path === state.docsSelectedPath) || null;
      }

      async function selectDoc(docPath) {
        state.docsSelectedPath = docPath;
        renderDocsVirtualList();
        const selected = getSelectedDoc();
        if (!selected) return;
        elements.docsPreviewTitle.textContent = selected.path;
        elements.docsPreviewMeta.textContent = `run_id：${selected.run_id}｜node_id：${selected.node_id}`;
        elements.docsOpen.disabled = false;
        elements.docsDownload.disabled = false;
        elements.docsInsert.disabled = false;
        try {
          const payload = await apiFetch(`/projects/${encodeURIComponent(state.projectId)}/docs/content?path=${encodeURIComponent(selected.path)}`);
          elements.docsPreviewContent.innerHTML = renderMarkdown(payload.content || "");
        } catch (error) {
          elements.docsPreviewContent.innerHTML = `<p class="empty-context">預覽失敗：${escapeHtml(error.message)}</p>`;
        }
      }

      async function loadDocsPage() {
        if (!state.projectId) {
          elements.docsTreeMeta.textContent = "請先選擇專案。";
          state.docsSelectedPath = null;
          elements.docsOpen.disabled = true;
          elements.docsDownload.disabled = true;
          elements.docsInsert.disabled = true;
          elements.docsPreviewTitle.textContent = "請從左側選擇文件";
          elements.docsPreviewMeta.textContent = "來源 run / node 將顯示於此。";
          elements.docsPreviewContent.innerHTML = '<p class="empty-context">尚未選擇文件。</p>';
          state.docsFlatItems = [];
          renderDocsVirtualList();
          return;
        }
        const payload = await apiFetch(`/projects/${encodeURIComponent(state.projectId)}/docs`);
        const docs = (payload.docs || []).map(normalizeDocItem);
        state.docsItems = docs;
        state.docsFlatItems = buildDocsTree(docs);
        elements.docsTreeMeta.textContent = `共 ${docs.length} 份文件（虛擬列表模式）`;
        if (!docs.find((doc) => doc.path === state.docsSelectedPath)) {
          state.docsSelectedPath = docs[0]?.path || null;
        }
        renderDocsVirtualList();
        if (state.docsSelectedPath) {
          await selectDoc(state.docsSelectedPath);
        }
      }

      async function renderGraph(code) {
        elements.graphPreview.innerHTML = "";
        if (!code) return;
        try {
          const { svg } = await window.__mermaid.render(`graphPreview-${Date.now()}`, code);
          elements.graphPreview.innerHTML = svg;
          decorateMermaidNodes();
        } catch (error) {
          elements.graphPreview.innerHTML = "<p>Mermaid 渲染失敗，請檢查 graph。</p>";
        }
      }

      function normalizeNodeStatus(status) {
        if (status === "completed") return "succeeded";
        if (["pending", "running", "failed", "succeeded"].includes(status)) return status;
        return "pending";
      }

      function getNodeState(nodeId) {
        return state.graphNodeStates?.[nodeId] || { status: "pending" };
      }

      function nodeStatusLabel(status) {
        const normalized = normalizeNodeStatus(status);
        if (normalized === "running") return "執行中";
        if (normalized === "succeeded") return "成功";
        if (normalized === "failed") return "失敗";
        return "等待中";
      }

      function renderNodeList() {
        elements.graphNodeList.innerHTML = "";
        const nodes = state.graph?.nodes || [];
        if (!nodes.length) return;
        nodes.forEach((node) => {
          const stateItem = getNodeState(node.id);
          const status = normalizeNodeStatus(stateItem.status);
          const item = document.createElement("li");
          item.className = "graph-node-item";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "graph-node-item__button";
          btn.innerHTML = `<span>${node.id}</span><span class="node-status node-status--${status}">${nodeStatusLabel(status)}</span>`;
          btn.addEventListener("click", () => openNodeDrawer(node.id));
          item.appendChild(btn);
          elements.graphNodeList.appendChild(item);
        });
      }

      function decorateMermaidNodes() {
        const groups = elements.graphPreview.querySelectorAll("g.node");
        groups.forEach((group) => {
          const label = group.querySelector(".nodeLabel")?.textContent?.trim();
          if (!label) return;
          const status = normalizeNodeStatus(getNodeState(label).status);
          group.classList.add(`node-status--${status}`);
          group.style.cursor = "pointer";
          group.addEventListener("click", () => openNodeDrawer(label));
        });
      }

      function inferNodeInputs(node) {
        const payload = {};
        ["args", "input", "inputs", "prompt", "content", "tool"].forEach((key) => {
          if (node[key] !== undefined) payload[key] = node[key];
        });
        return payload;
      }

      function extractOutputArtifacts(output) {
        if (!output || typeof output !== "object") return { docs: [], artifacts: [], raw: output };
        return {
          docs: output.docs || output.documents || [],
          artifacts: output.artifacts || output.files || [],
          raw: output,
        };
      }

      function openNodeDrawer(nodeId) {
        const node = (state.graph?.nodes || []).find((item) => item.id === nodeId);
        if (!node) return;
        state.graphSelectedNodeId = nodeId;
        const nodeState = getNodeState(nodeId);
        const executionEngine = node.type && String(node.type).includes("tool") ? "tool" : "llm";
        elements.graphNodeTitle.textContent = `Node：${nodeId}`;
        elements.graphNodeMeta.textContent = `status：${nodeStatusLabel(nodeState.status)} ｜ execution_engine：${executionEngine}`;
        elements.graphNodeInputs.textContent = JSON.stringify(inferNodeInputs(node), null, 2);
        elements.graphNodeOutputs.textContent = JSON.stringify(extractOutputArtifacts(nodeState.output), null, 2);
        elements.graphNodeEvents.innerHTML = "";
        state.graphEvents
          .filter((event) => event.node_id === nodeId || event.from === nodeId || event.to === nodeId)
          .slice(-8)
          .forEach((event) => {
            const item = document.createElement("li");
            item.textContent = JSON.stringify(event);
            elements.graphNodeEvents.appendChild(item);
          });
        if (!elements.graphNodeEvents.children.length) {
          const item = document.createElement("li");
          item.textContent = "尚無 events/logs";
          elements.graphNodeEvents.appendChild(item);
        }
        elements.graphNodeDrawer.hidden = false;
      }

      function closeNodeDrawer() {
        elements.graphNodeDrawer.hidden = true;
      }

      function queuePlanCommand(command, args, description) {
        showPlanCard({
          command,
          args,
          plan_card: `${description}\n\ncommand: ${command}\nargs: ${JSON.stringify(args, null, 2)}`,
        });
      }

      function showPlanCard(plan) {
        state.plan = plan;
        elements.planContent.textContent = plan.plan_card || "";
        renderPlanList(elements.planCommands, plan.commands || []);
        renderPlanList(elements.planPatches, plan.graph_patches || []);
        renderPlanRisk(plan);
        elements.planCard.hidden = false;
      }

      async function applySessionFromEvent(data) {
        if (!data) return;
        let projectChanged = false;
        if (data.project_id && data.project_id !== state.projectId) {
          setProjectState(data.project_id);
          projectChanged = true;
        }
        if (data.chat_id) {
          state.chatId = data.chat_id;
        }
        if (projectChanged) {
          await loadProjects();
        }
      }

      async function confirmPlan(confirmed) {
        if (!state.plan) return;
        try {
          const path = state.plan.confirm_api || "/chat/plan/confirm";
          const payload =
            path === "/chat/plan/confirm"
              ? await apiFetch(path, {
                  method: "POST",
                  body: JSON.stringify({
                    project_id: state.projectId,
                    chat_id: state.chatId,
                    command: state.plan.command,
                    args: state.plan.args || {},
                    confirmed,
                  }),
                })
              : await apiFetch(path, {
                  method: "POST",
                  body: JSON.stringify({ ...state.plan.args, confirmed }),
                });
          appendMessage("agent", confirmed ? "已確認執行。" : "已取消執行。");
          if (confirmed && state.plan?.command === "graph.template.create") {
            state.graphTemplateId = payload.result?.template_id || state.graphTemplateId;
            if (state.graphTemplateId) {
              showToast(`Template 已建立：${state.graphTemplateId}`);
            }
          }
          resetPlanCard();
          if (state.projectId) {
            await loadContext();
          }
          if (path !== "/chat/plan/confirm") {
            await loadToolsSkillsPage();
          }
        } catch (error) {
          showToast(`Plan 執行失敗：${error.message}`);
        }
      }

      function buildAttachmentSummary(attachments) {
        if (!attachments || attachments.length === 0) return "";
        const lines = attachments.map((file) => {
          const sizeKb = Math.round(file.size / 1024);
          return `- ${file.name} (${file.type || "未知格式"}, ${sizeKb} KB)`;
        });
        return `\n\n[附件摘要]\n${lines.join("\n")}`;
      }

      function updateThinking(payload = {}) {
        const mode = state.thinkingMode;
        if (mode === "off") {
          elements.thinkingSummary.textContent = "Thinking 顯示已關閉";
          elements.thinkingDetail.textContent = "";
          return;
        }
        const status = payload.status || "分析中";
        const brief = payload.brief || "正在整理回覆與執行計畫";
        elements.thinkingSummary.textContent = `狀態：${status}｜${brief}`;
        elements.thinkingDetail.textContent = mode === "verbose" ? (payload.verbose || brief) : brief;
      }

      function renderArtifacts(artifacts = []) {
        elements.artifactList.innerHTML = "";
        if (!artifacts.length) {
          elements.artifactList.innerHTML = '<p class="empty-context">目前尚無 artifact</p>';
          return;
        }
        artifacts.forEach((artifact) => {
          const card = document.createElement("article");
          card.className = "artifact-card";
          card.innerHTML = `
            <header>
              <strong>${artifact.type}</strong>
              <span>${artifact.run_id}/${artifact.node_id}</span>
            </header>
            <p>${artifact.path}</p>
            <pre>${escapeHtml(artifact.preview || "(無預覽)")}</pre>
            <div class="artifact-card__actions">
              <button type="button" class="secondary-btn small" data-artifact-action="open">Open</button>
              <button type="button" class="secondary-btn small" data-artifact-action="download">Download</button>
              <button type="button" class="secondary-btn small" data-artifact-action="pin">Pin</button>
            </div>`;
          card.querySelectorAll("[data-artifact-action]").forEach((btn) => {
            btn.addEventListener("click", () => {
              showToast(`已收到 ${btn.dataset.artifactAction} 請求：${artifact.path}`);
            });
          });
          elements.artifactList.appendChild(card);
        });
      }

      function applyTokenChunk(text = "") {
        if (!state.pendingAssistantBubble) {
          state.pendingAssistantBubble = appendMessage("agent", "Amon：", { status: "streaming" });
          state.pendingAssistantBubble.dataset.buffer = "";
        }
        state.pendingAssistantBubble.dataset.buffer = `${state.pendingAssistantBubble.dataset.buffer || ""}${text}`;
        state.pendingAssistantBubble.innerHTML = renderMarkdown(`Amon：${state.pendingAssistantBubble.dataset.buffer}`);
        elements.timeline.scrollTop = elements.timeline.scrollHeight;
      }

      function finalizeAssistantBubble() {
        state.pendingAssistantBubble = null;
      }

      function startStream(message, attachments = []) {
        resetPlanCard();
        const finalMessage = `${message}${buildAttachmentSummary(attachments)}`;
        appendMessage("user", `你：${finalMessage}`);
        appendTimelineStatus("訊息已送出，等待事件回傳中...");
        updateThinking({ status: "queued", brief: "已送出，等待伺服器事件" });
        setStreaming(true);

        state.streamClient = new EventStreamClient({
          preferSSE: true,
          sseUrlBuilder: (params, lastEventId) => {
            const query = new URLSearchParams({ message: params.message });
            if (params.project_id) query.set("project_id", params.project_id);
            if (params.chat_id) query.set("chat_id", params.chat_id);
            if (lastEventId) query.set("last_event_id", lastEventId);
            return `/v1/chat/stream?${query.toString()}`;
          },
          wsUrlBuilder: (params, lastEventId) => {
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const query = new URLSearchParams({ message: params.message });
            if (params.project_id) query.set("project_id", params.project_id);
            if (params.chat_id) query.set("chat_id", params.chat_id);
            if (lastEventId) query.set("last_event_id", lastEventId);
            return `${protocol}://${window.location.host}/v1/chat/ws?${query.toString()}`;
          },
          onStatusChange: ({ status, transport }) => {
            if (status === "connected") {
              elements.shellDaemonStatus.textContent = "Daemon：Healthy";
            }
            if (status === "reconnecting") {
              elements.shellDaemonStatus.textContent = "Daemon：Reconnecting";
              showToast(`串流中斷，正在重新連線（${transport || "unknown"}）`);
            }
            if (status === "error") {
              elements.shellDaemonStatus.textContent = "Daemon：Unavailable";
            }
          },
          onEvent: async (eventType, data) => {
            try {
              state.uiStore.applyEvent(eventType, data);
              await applySessionFromEvent(data);
              if (state.projectId && ["result", "done", "notice"].includes(eventType)) {
                await loadContext();
              }
              if (eventType === "token") {
                applyTokenChunk(data.text || "");
                return;
              }
              if (eventType === "notice") {
                if (data.text) appendMessage("agent", data.text);
                return;
              }
              if (eventType === "plan") {
                showPlanCard(data);
                appendMessage("agent", "Amon：已產生 Plan Card，請確認。");
                return;
              }
              if (eventType === "result") {
                appendMessage("agent", `Amon：

\`\`\`json
${JSON.stringify(data, null, 2)}
\`\`\``);
                return;
              }
              if (eventType === "error") {
                showToast(data.message || "串流失敗");
                return;
              }
              if (eventType === "done") {
                await applySessionFromEvent(data);
                const doneStatus = data.status || "ok";
                if (doneStatus !== "ok" && doneStatus !== "confirm_required") {
                  appendMessage("agent", `Amon：流程結束（${doneStatus}）。我已收到你的訊息，請調整描述後再送出，我會持續回應。`);
                  appendTimelineStatus(`流程狀態：${doneStatus}`);
                }
                finalizeAssistantBubble();
                state.streamClient?.stop();
                state.streamClient = null;
                setStreaming(false);
                await loadProjects();
                if (state.projectId) {
                  await loadContext();
                }
              }
            } catch (error) {
              console.error("stream_event_error", error);
              showToast(`事件處理失敗：${error.message || error}`);
            }
          },
        });

        state.streamClient.start({
          message: finalMessage,
          project_id: state.projectId,
          chat_id: state.chatId,
        });
      }

      function renderAttachmentPreview() {
        elements.attachmentPreview.innerHTML = "";
        if (!state.attachments || state.attachments.length === 0) return;
        state.attachments.forEach((file) => {
          const item = document.createElement("div");
          item.className = "attachment-item";
          const info = document.createElement("div");
          info.className = "attachment-info";
          info.textContent = `${file.name} (${Math.round(file.size / 1024)} KB)`;
          if (file.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.alt = file.name;
            img.src = URL.createObjectURL(file);
            img.onload = () => URL.revokeObjectURL(img.src);
            item.appendChild(img);
          } else if (file.type.startsWith("video/")) {
            const video = document.createElement("video");
            video.src = URL.createObjectURL(file);
            video.controls = true;
            video.onloadeddata = () => URL.revokeObjectURL(video.src);
            item.appendChild(video);
          } else if (file.type === "application/pdf") {
            const embed = document.createElement("embed");
            embed.src = URL.createObjectURL(file);
            embed.type = "application/pdf";
            embed.onload = () => URL.revokeObjectURL(embed.src);
            item.appendChild(embed);
          }
          item.appendChild(info);
          elements.attachmentPreview.appendChild(item);
        });
      }

      elements.shellNavItems.forEach((button) => {
        button.addEventListener("click", async () => {
          elements.shellNavItems.forEach((item) => item.classList.remove("is-active"));
          button.classList.add("is-active");
          const view = button.dataset.shellView || "chat";
          switchShellView(view);
          if (view === "tools-skills") {
            await loadToolsSkillsPage();
          }
          if (view === "config") {
            await loadConfigPage();
          }
          if (view === "logs-events") {
            await loadLogsEventsPage();
          }
          if (view === "docs") {
            await loadDocsPage();
          }
          if (view === "bill") {
            await loadBillPage();
          }
        });
      });

      elements.logsRefresh.addEventListener("click", () => loadLogsPage(1));
      elements.eventsRefresh.addEventListener("click", () => loadEventsPage(1));
      elements.logsPrev.addEventListener("click", () => loadLogsPage(Math.max(1, state.logsPage.logsPage - 1)));
      elements.logsNext.addEventListener("click", () => {
        if (state.logsPage.logsHasNext) {
          loadLogsPage(state.logsPage.logsPage + 1);
        }
      });
      elements.eventsPrev.addEventListener("click", () => loadEventsPage(Math.max(1, state.logsPage.eventsPage - 1)));
      elements.eventsNext.addEventListener("click", () => {
        if (state.logsPage.eventsHasNext) {
          loadEventsPage(state.logsPage.eventsPage + 1);
        }
      });
      elements.logsDownload.addEventListener("click", () => {
        const url = `/v1/logs/download?${buildLogsQuery(1).toString()}`;
        window.open(url, "_blank", "noopener");
      });

      elements.toolsSkillsRefresh.addEventListener("click", loadToolsSkillsPage);
      elements.docsRefresh.addEventListener("click", loadDocsPage);
      elements.docsTreeViewport.addEventListener("scroll", renderDocsVirtualList);
      elements.docsOpen.addEventListener("click", () => {
        const selected = getSelectedDoc();
        if (!selected || !state.projectId) return;
        window.open(`/v1/projects/${encodeURIComponent(state.projectId)}/docs/content?path=${encodeURIComponent(selected.path)}`, "_blank", "noopener");
      });
      elements.docsDownload.addEventListener("click", () => {
        const selected = getSelectedDoc();
        if (!selected || !state.projectId) return;
        window.open(`/v1/projects/${encodeURIComponent(state.projectId)}/docs/download?path=${encodeURIComponent(selected.path)}`, "_blank", "noopener");
      });
      elements.docsInsert.addEventListener("click", () => {
        const selected = getSelectedDoc();
        if (!selected) return;
        const docRef = ` @doc(${selected.path})`;
        elements.chatInput.value = `${elements.chatInput.value}${docRef}`.trim();
        elements.chatInput.focus();
        showToast("已插入 @doc 引用。");
      });
      elements.configRefresh.addEventListener("click", loadConfigPage);
      elements.billRefresh.addEventListener("click", loadBillPage);
      elements.configSearch.addEventListener("input", renderConfigTable);
      elements.configExport.addEventListener("click", exportEffectiveConfig);
      elements.skillTriggerPreview.addEventListener("click", async () => {
        const skillName = elements.skillTriggerSelect.value;
        if (!skillName) {
          showToast("請先選擇 skill。");
          return;
        }
        try {
          const payload = await apiFetch("/skills/trigger-preview", {
            method: "POST",
            body: JSON.stringify({ skill_name: skillName, project_id: state.projectId || "" }),
          });
          elements.skillInjectionPreview.textContent = JSON.stringify(payload, null, 2);
          showToast("已產生 skill 注入預覽。");
        } catch (error) {
          showToast(`技能預覽失敗：${error.message}`);
        }
      });

      elements.chatForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const message = elements.chatInput.value.trim();
        if (!message) return;
        const attachments = [...state.attachments];
        elements.chatInput.value = "";
        elements.chatAttachments.value = "";
        state.attachments = [];
        renderAttachmentPreview();
        startStream(message, attachments);
      });

      elements.projectSelect.addEventListener("change", async (event) => {
        const selectedProject = event.target.value;
        setProjectState(selectedProject);
        await loadProjectHistory();
        if (state.projectId) {
          await ensureChatSession();
          await loadContext();
        }
        if (state.shellView === "tools-skills") {
          await loadToolsSkillsPage();
        }
        if (state.shellView === "config") {
          await loadConfigPage();
        }
        if (state.shellView === "logs-events") {
          await loadLogsEventsPage();
        }
        if (state.shellView === "docs") {
          await loadDocsPage();
        }
        if (state.shellView === "bill") {
          await loadBillPage();
        }
      });

      elements.refreshContext.addEventListener("click", loadContext);
      elements.planConfirm.addEventListener("click", () => confirmPlan(true));
      elements.planCancel.addEventListener("click", () => confirmPlan(false));
      elements.graphNodeClose.addEventListener("click", closeNodeDrawer);
      elements.graphCreateTemplate.addEventListener("click", () => {
        if (!state.projectId || !state.graphRunId) {
          showToast("需要先有 run 才能建立 template。");
          return;
        }
        queuePlanCommand(
          "graph.template.create",
          { project_id: state.projectId, run_id: state.graphRunId, name: `${state.projectId}-${state.graphRunId}` },
          "建立 graph template（需確認）"
        );
      });
      elements.graphParametrize.addEventListener("click", () => {
        if (!state.graphTemplateId) {
          showToast("請先 Create template。\n此操作需要 Plan Card。");
          return;
        }
        if (!state.graphSelectedNodeId) {
          showToast("請先選擇 node。");
          return;
        }
        const varName = window.prompt("請輸入變數名稱（例如 customer_name）", "var");
        if (!varName) return;
        const jsonPath = window.prompt("請輸入 JSONPath（例如 $.nodes[0].args.prompt）", "");
        if (!jsonPath) return;
        queuePlanCommand(
          "graph.template.parametrize",
          { template_id: state.graphTemplateId, jsonpath: jsonPath, var_name: varName },
          `參數化 template（需確認）\nnode: ${state.graphSelectedNodeId}`
        );
      });
      elements.chatAttachments.addEventListener("change", (event) => {
        state.attachments = Array.from(event.target.files || []);
        renderAttachmentPreview();
      });
      elements.contextTabs.forEach((tab) => {
        tab.addEventListener("click", () => switchContextTab(tab.dataset.contextTab));
      });

      elements.thinkingMode.addEventListener("change", (event) => {
        state.thinkingMode = event.target.value;
        updateThinking({ status: "idle", brief: "已切換 Thinking 顯示模式" });
      });

      (async () => {
        try {
          switchShellView("chat");
          await loadProjects();
          setProjectState(state.projectId);
          renderArtifacts([]);
          updateThinking({ status: "idle", brief: "目前沒有 Thinking 事件" });
          await loadProjectHistory();
          if (state.projectId) {
            await ensureChatSession();
            await loadContext();
          }
        } catch (error) {
          showToast(`初始化失敗：${error.message}`);
        }
      })();
    </script>
  </body>
</html>
